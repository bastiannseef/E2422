---
title: "*Caso2 - Envíos*"
author: "Sebastian Matias Romero Davila"
date: "2024-07-10"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: yes
    collapsed: yes
    smooth_scroll: yes
    theme: journal
    highlight: kate
    df_print: paged
    code_folding: show
---

\newpage

# *Base de datos inicial*
Cargamos librerías a emplear

```{r message=FALSE,warning=FALSE}
library(tidyverse)
library(rio)
library(kableExtra)
```

Base: base_envíos

```{r message=FALSE,warning=FALSE}
base_envíos <- import("base_envíos.csv")
head(base_envíos,10) %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped","scale_down","HOLD_position"))
```


# *Características Inherentes*

## Exactitud

Para la representación correcta de la realidad de los datos, empezamos identificando los tipos de variables

```{r}
base_envíos %>% glimpse()
```

Luego, verificamos si existen inexactitudes

- id_envío: Se encuentran valores enteros negativos

- fecha_envío y fecha_entrega: Formato inadecuado 

```{r}
envinexactos <- base_envíos %>% filter(
  id_envío<0|substr(fecha_envío,3,3) == "-"
)
head(envinexactos,10) %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

## Completitud
<!-- Medida en que todos los valores necesarios están presentes. -->

En la tabla se observan valores faltantes en varias de las filas.

```{r message=FALSE, warning=FALSE}
envios_faltantes <- base_envíos %>% 
  filter(
    if_any(everything(), is.na)
  )
head(envios_faltantes,10) %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

Cantidad total de datos faltantes por cada columna en el conjunto de datos.

```{r message=FALSE, warning=FALSE}
na_envíos <- colSums(is.na(base_envíos))
na_envíos
```

Entonces, ajustaremos los valores faltantes (NA) de la siguiente manera:

origen: Se reemplazará con "No identificado".

destino: Se reemplazará con "No identificado".

monto_envío: Se asignará como -1 en caso de estar ausente.

```{r message=FALSE}
base1 <- base_envíos %>% mutate(
  origen = case_when(
    !is.na(origen) ~ origen,
    is.na(origen) ~ "No identificado"
  ),
  destino = case_when(
    !is.na(destino) ~ destino,
    is.na(destino) ~ "No identificado"
  ),
  fecha_entrega = case_when(
    !is.na(fecha_entrega) ~ fecha_entrega,
    is.na(fecha_entrega) ~ NA
  ),
  monto_envío = case_when(
    !is.na(monto_envío) ~ monto_envío,
    is.na(monto_envío) ~ -1
  )
)
head(base1,10) %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

## Consistencia
<!-- Coherencia de los datos dentro del contexto. -->

Previamente, se identificaron inconsistencias en las variables id_vendedor y nombre_vendedor, así como un problema con el formato de la variable fecha_venta. Para abordar estas cuestiones, se realizaron las siguientes acciones:

```{r message=FALSE}
base2 <- base1 %>% mutate(
  id_envío = case_when(
    id_envío<0 ~ as.integer((-1)*id_envío),
    id_envío>=0 ~ as.integer(id_envío)
    ),
  origen = as.character(origen),
  fecha_envío = as.Date(case_when(
    substr(fecha_envío,3,3) == "-" ~ paste( substr(fecha_envío,7,10),
                                              substr(fecha_envío,4,5),
                                              substr(fecha_envío,1,2),
                                              sep = "-"),
    substr(fecha_envío,3,3) != "-" ~ fecha_envío)
    ),
  fecha_entrega = as.Date(fecha_entrega, origin = "1970-01-01"),
  monto_envío = round(monto_envío,2), 
  )
head(base2,10) %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position")) 
```

Hay fechas de entrega que están situadas antes de la fecha de envío, procedemos a hacer el intercambio respectivo.

```{r message=FALSE}
base3 <- base2 %>% mutate(
  fecha_temporal = fecha_envío,
    fecha_envío = case_when(
      fecha_envío > fecha_entrega ~ fecha_entrega,
      TRUE ~ fecha_envío
    ),
    fecha_entrega = case_when(
      fecha_temporal > fecha_entrega ~ fecha_temporal,
      is.na(fecha_entrega) ~ NA,
      TRUE ~ fecha_entrega
    ),
) %>% select(-fecha_temporal)
head(base3,10) %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

Nos piden crear una variable para la duración del envío, en este caso, en meses.

```{r message=FALSE}
base4 <- base3 %>% mutate(
    duración_envío_meses = trunc(as.integer(difftime(fecha_entrega,fecha_envío,units = "days")/30))
)    
head(base4,10) %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

Agrupamos por origen y destino (región), y obtenemos la duración de envío promedio en meses.

```{r message=FALSE}
prom_envi <- base4 %>% filter(!is.na(duración_envío_meses)) %>% 
  select(origen,destino,duración_envío_meses) %>%
  group_by(origen,destino) %>% 
  summarise(mean_duración_envío_meses = trunc(mean(duración_envío_meses)))
prom_envi %>%
kable(booktabs = TRUE,format = "latex") %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```


# *Características Dependientes del sistema*

## Disponibilidad
Medida en que los datos están disponibles y accesibles cuando se necesitan.

https://github.com/bastiannseef/E2422/tree/main/Caso2/data_procesada_caso2

## Portabilidad
Para trasladar los datos evaluados bajo el criterio de calidad de la norma ISO/IEC 25012 entre sistemas, guardamos las bases de datos procesadas en archivos “.csv” y también, en formato “.rds” para garantizar eficiencia, portabilidad y seguridad.

Encontrará los siguientes archivos:

- data_caso2.csv: Data general evaluada por los criterios de calidad en formato ".csv".

- data_caso2.rds: Data general evaluada por los criterios de calidad en formato ".rds".

- quantiles_cliente.csv: Data duración promedio de envío en formato ".csv".

- quantiles_cliente.rds: Data duración promedio de envío en formato ".rds".


```{r}
data.frame(base4) %>%
  saveRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso2/data_procesada_caso2/datos_caso2.rds")

readRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso2/data_procesada_caso2/datos_caso2.rds") %>%
  export("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso2/data_procesada_caso2/data_caso2.csv")

data.frame(prom_envi) %>%
  saveRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso2/data_procesada_caso2/prom_envi.rds")

readRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso2/data_procesada_caso2/prom_envi.rds") %>%
  export("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso2/data_procesada_caso2/prom_envi.csv")
```



