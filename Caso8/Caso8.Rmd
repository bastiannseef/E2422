---
title: "*Caso8 - Transacciones*"
author: "Sebastian Matias Romero Davila"
date: "2024-07-12"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
    keep_tex: yes  # Mantener el archivo .tex generado
    latex_engine: pdflatex  # Motor LaTeX a utilizar
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: yes
    collapsed: yes
    smooth_scroll: yes
    theme: journal
    highlight: kate
    df_print: paged
    code_folding: show
---

\newpage

# *Base de datos inicial*
Cargamos librerías a emplear

```{r message=FALSE,warning=FALSE}
library(tidyverse)
library(rio) 
library(kableExtra)
```

Base: base_suscripiones 

```{r message=FALSE,warning=FALSE}
base_transacciones <- import("base_transacciones.csv")
head(base_transacciones,10) %>%
kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```


# *Características Inherentes*

## Exactitud

Para la representación correcta de la realidad de los datos, empezamos identificando los tipos de variables

```{r}
base_transacciones %>% glimpse()
```

Luego, verificamos si existen inexactitudes

- id_transaccion: Se encuentran valores enteros negativos

- fecha_transaccion: Formato inadecuado 

```{r}
inexactostrans <- base_transacciones %>% filter(
  id_transaccion<0|substr(fecha_transaccion,3,3) == "-"
)
head(inexactostrans,10) %>%
kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

## Completitud
<!-- Medida en que todos los valores necesarios están presentes. -->

En la tabla se observan valores faltantes en varias de las filas.

```{r message=FALSE, warning=FALSE}
transacciones_faltantes <- base_transacciones %>% 
  filter(
    if_any(everything(), is.na)
  )
head(transacciones_faltantes,10) %>%
kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

Cantidad total de datos faltantes por cada columna en el conjunto de datos.

```{r message=FALSE, warning=FALSE}
na_transacciones <- colSums(is.na(base_transacciones))
na_transacciones
```

Como hay gran cantidad de datos faltantes en las variables monto, tipo_transaccion y estado_transaccion, existe la ligera sospecha de encontrar alguna fila con las 3 variables vacías.

```{r}
faltante <- base_transacciones %>% filter(
  is.na(monto) & is.na(tipo_transaccion) & is.na(estado_transaccion))
faltante %>% kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

No podemos rescatar esta fila, por lo que procedemos actualizar la base de datos sin considerarla.

```{r}
base_transacciones <- base_transacciones %>% filter(
  !(is.na(monto) & is.na(tipo_transaccion) & is.na(estado_transaccion)))
```

Entonces, ajustaremos los valores faltantes (NA) de la siguiente manera:

tipo_transaccion: Se reemplazará con "No identificado".

estado_transaccion: Se reemplazará con "Indeterminado".

monto: Se asignará como -1 en caso de estar ausente.

```{r}
transacciones1 <- base_transacciones %>% mutate(
  tipo_transaccion = case_when(
    !is.na(tipo_transaccion) ~ tipo_transaccion,
    is.na(tipo_transaccion) ~ "No identificado"
  ),
  estado_transaccion = case_when(
    !is.na(estado_transaccion) ~ estado_transaccion,
    is.na(estado_transaccion) ~ "Indeterminado"
  ),
  monto = case_when(
    !is.na(monto) ~ monto,
    is.na(monto) ~ -1
  ),
)
head(transacciones1,10) %>%
kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```


## Consistencia
<!-- Coherencia de los datos dentro del contexto. -->

Previamente, se identificaron inconsistencias en las variables id_transaccion y fecha_transaccion. Para abordar estas cuestiones, se realizaron las siguientes acciones:


```{r}
transacciones2 <- transacciones1 %>% mutate(
  id_transaccion = abs(id_transaccion),
  fecha_transaccion = as.Date(case_when(
    substr(fecha_transaccion,3,3) == "-" ~ paste( substr(fecha_transaccion,7,10),
                                              substr(fecha_transaccion,4,5),
                                              substr(fecha_transaccion,1,2),
                                              sep = "-"),
    substr(fecha_transaccion,3,3) != "-" ~ fecha_transaccion)
    ) 
  ) %>% arrange(id_cliente,fecha_transaccion)
head(transacciones2,10) %>%
kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

Nos piden crear una para indicar la cantidad de días desde la última transacción.

```{r}
transacciones3 <- transacciones2 %>% mutate(
  last_transaction_days = c(NA,diff(fecha_transaccion)),
  last_transaction_days = case_when(
    last_transaction_days>=0 ~ last_transaction_days,
    last_transaction_days<0 ~ NA
  )
) %>% #filter(estado_transaccion == "Completada") %>%
  arrange(id_cliente,desc(monto))
head(transacciones3,10) %>%
kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

Por último, generamos una lista de transacciones con montos anormalmente altos.Para ello tomaremos en cuenta los quartiles 1 y 3, fuera de ese rango se ubican los datos anormales. Este intervalo será calculado dependiendo para cada cliente que tenga más de una transacción.


```{r}
quantiles_cliente <- transacciones3 %>%
  filter(monto != -1 & estado_transaccion == "Completada") %>%
  select(
    tipo_transaccion,monto,id_cliente,last_transaction_days
    ) %>% 
  group_by(id_cliente) %>% 
  filter(n() > 1) %>%
  mutate(
    cuantil1 = quantile(monto,0.25),
    cuantil3 = quantile(monto,0.75),
  ) %>% distinct(id_cliente, cuantil1, cuantil3)
head(quantiles_cliente,15) %>%
kable(booktabs = TRUE,format = "latex")%>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```

Obteniendo la siguiente tabla

```{r}
montos_anormales <- transacciones3 %>%
  filter(monto != -1 & estado_transaccion == "Completada") %>%
  select(
    id_cliente,tipo_transaccion,monto
    ) %>% 
  group_by(id_cliente) %>% 
  filter(n() > 1) %>%
  mutate(
    cuantil1 = quantile(monto,0.25),
    cuantil3 = quantile(monto,0.75),
  ) %>% ungroup() %>% 
  filter(monto < cuantil1 | monto > cuantil3) %>%
  select(-cuantil1,-cuantil3) %>% 
  arrange(id_cliente,desc(monto))
head(montos_anormales,20) %>%
 kable(booktabs = TRUE,format = "latex")%>%
   kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"))
```


# *Características Dependientes del sistema*

## Disponibilidad
Medida en que los datos están disponibles y accesibles cuando se necesitan.

https://github.com/bastiannseef/E2422/tree/main/Caso8/data_procesada_caso8

## Portabilidad
Para trasladar los datos evaluados bajo el criterio de calidad de la norma ISO/IEC 25012 entre sistemas, guardamos las bases de datos procesadas en archivos “.csv” y también, en formato “.rds” para garantizar eficiencia, portabilidad y seguridad.

Encontrará los siguientes archivos:

- data_caso8.csv: Data general evaluada por los criterios de calidad en formato ".csv".

- data_caso8.rds: Data general evaluada por los criterios de calidad en formato ".rds".

- quantiles_cliente.csv: Data cuantiles considerados para anormalidades en formato ".csv".

- quantiles_cliente.rds: Data cuantiles considerados para anormalidades en formato ".rds".

- montos_anormales.csv: Data montos anormales en formato ".csv".

- montos_anormales.rds: Data montos anormales en formato ".rds".

```{r}
data.frame(transacciones3) %>%
  saveRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/datos_caso8.rds")

data.frame(quantiles_cliente) %>%
  saveRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/quantiles_cliente.rds")

data.frame(montos_anormales) %>%
  saveRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/anormalidades.rds")

readRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/datos_caso8.rds") %>%
  export("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/data_caso8.csv")

readRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/quantiles_cliente.rds") %>%
  export("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/quantiles_cliente.csv")

readRDS("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/anormalidades.rds") %>%
  export("C:/Users/Sebastian/OneDrive/Escritorio/Repaso/Caso8/data_procesada_caso8/anormalidades.rds")

```










